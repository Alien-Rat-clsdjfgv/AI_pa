{% extends 'layout.html' %}

{% block content %}
<!-- 語音輸入按鈕 - 固定在右下角 -->
<div id="voice-input-button" class="position-fixed bottom-0 end-0 mb-5 me-3 d-flex flex-column" style="z-index: 1050;">
    <div id="voice-status" class="d-none mb-2 p-2 rounded text-center text-white bg-dark">準備中...</div>
    <div id="voice-language-container" class="mb-2 bg-dark p-2 rounded shadow-sm d-none">
        <select id="voice-language" class="form-select form-select-sm">
            <option value="zh-TW">中文 (繁體)</option>
            <option value="zh-CN">中文 (簡體)</option>
            <option value="en-US">英文</option>
            <option value="ja-JP">日文</option>
        </select>
    </div>
    <button id="voice-button" class="btn btn-primary rounded-circle shadow-lg p-3" style="width: 60px; height: 60px;" title="點擊開始語音輸入">
        <i class="fas fa-microphone"></i>
    </button>
</div>
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-4">醫療病例生成系統</h1>
            
            <!-- API connection warning if needed -->
            {% if not api_connected %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i> 
                請連接您的 OpenAI API 金鑰以生成病例。
            </div>
            {% endif %}
            
            <!-- Case Generator Form -->
            <!-- 語音輸入功能說明 -->
            <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-microphone fa-2x me-3"></i>
                    <div>
                        <strong>語音輸入功能已啟用!</strong> 
                        <p class="mb-0">點擊右下角的麥克風圖標，選擇要輸入的文本框，然後開始說話。支援中文（繁體/簡體）、英文和日文。</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">生成新病例</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="saveCase" checked>
                        <label class="form-check-label" for="saveCase">儲存病例</label>
                    </div>
                </div>
                <div class="card-body">
                    <form id="caseGeneratorForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="specialty" class="form-label">專科</label>
                                <select class="form-select mb-2" id="specialty" name="specialty">
                                    <option value="">選擇專科</option>
                                    <option value="內科">內科</option>
                                    <option value="外科">外科</option>
                                    <option value="兒科">兒科</option>
                                    <option value="婦產科">婦產科</option>
                                    <option value="精神科">精神科</option>
                                    <option value="神經科">神經科</option>
                                    <option value="心臟科">心臟科</option>
                                    <option value="腸胃科">腸胃科</option>
                                    <option value="呼吸科">呼吸科</option>
                                    <option value="腎臟科">腎臟科</option>
                                    <option value="皮膚科">皮膚科</option>
                                    <option value="骨科">骨科</option>
                                    <option value="泌尿科">泌尿科</option>
                                    <option value="眼科">眼科</option>
                                    <option value="耳鼻喉科">耳鼻喉科</option>
                                    <option value="血液腫瘤科">血液腫瘤科</option>
                                    <option value="感染科">感染科</option>
                                    <option value="急診醫學">急診醫學</option>
                                    <option value="家庭醫學">家庭醫學</option>
                                    <option value="老年醫學">老年醫學</option>
                                    <option value="其他">其他</option>
                                </select>
                                <!-- 常用專科快速按鈕 -->
                                <div class="d-flex flex-wrap gap-1 mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary specialty-template-btn" data-specialty="內科" data-template="internal-med">內科</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary specialty-template-btn" data-specialty="心臟科" data-template="cardiology">心臟科</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary specialty-template-btn" data-specialty="腸胃科" data-template="gastroenterology">腸胃科</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary specialty-template-btn" data-specialty="呼吸科" data-template="pulmonology">呼吸科</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary specialty-template-btn" data-specialty="急診醫學" data-template="er">急診</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="complexity" class="form-label">複雜度</label>
                                <select class="form-select" id="complexity" name="complexity">
                                    <option value="簡單">簡單</option>
                                    <option value="中等" selected>中等</option>
                                    <option value="複雜">複雜</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="patientAge" class="form-label">患者年齡</label>
                                <input type="text" class="form-control" id="patientAge" name="patientAge" value="45">
                            </div>
                            <div class="col-md-6">
                                <label for="patientGender" class="form-label">患者性別</label>
                                <select class="form-select" id="patientGender" name="patientGender">
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="chief_complaint" class="form-label">主訴</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="chief_complaint" name="chief_complaint" placeholder="輸入患者主訴...">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">常見主訴</button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" data-complaint="發燒三天">發燒三天</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="頭痛一週">頭痛一週</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="腹痛兩天">腹痛兩天</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="咳嗽兩週">咳嗽兩週</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="呼吸困難">呼吸困難</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="胸痛">胸痛</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="腹瀉">腹瀉</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="噁心嘔吐">噁心嘔吐</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="關節疼痛">關節疼痛</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="皮疹">皮疹</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="視力模糊">視力模糊</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="耳鳴">耳鳴</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="頭暈">頭暈</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="失眠">失眠</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="體重減輕">體重減輕</a></li>
                                    <li><a class="dropdown-item" href="#" data-complaint="疲勞">疲勞</a></li>
                                </ul>
                            </div>
                            
                            <!-- 常見主訴快速按鈕 -->
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary common-complaint-btn" data-complaint="發燒三天">發燒</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary common-complaint-btn" data-complaint="頭痛一週">頭痛</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary common-complaint-btn" data-complaint="腹痛兩天">腹痛</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary common-complaint-btn" data-complaint="咳嗽兩週">咳嗽</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary common-complaint-btn" data-complaint="呼吸困難">呼吸困難</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary common-complaint-btn" data-complaint="胸痛">胸痛</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary common-complaint-btn" data-complaint="噁心嘔吐">噁心嘔吐</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary common-complaint-btn" data-complaint="頭暈">頭暈</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="history_present_illness" class="form-label">現病史 (Present Illness)</label>
                            <div class="d-flex mb-2">
                                <textarea class="form-control" id="history_present_illness" name="history_present_illness" rows="3" placeholder="輸入患者現病史..."></textarea>
                                <button type="button" class="btn btn-outline-success ms-2" id="generatePresentIllnessBtn" style="white-space: nowrap;">
                                    <i class="fas fa-magic me-1"></i> 自動生成
                                </button>
                            </div>
                            <div class="alert alert-info d-none" id="generatingPresentIllnessAlert">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <span>正在生成現病史...</span>
                                </div>
                            </div>
                            <div class="alert alert-danger d-none" id="presentIllnessErrorAlert"></div>
                            
                            <!-- 現病史按鈕 -->
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary present-illness-btn" data-illness="症狀持續時間: 3天" data-target="presentIllness">持續3天</button>
                                <button type="button" class="btn btn-sm btn-outline-primary present-illness-btn" data-illness="症狀持續時間: 1週" data-target="presentIllness">持續1週</button>
                                <button type="button" class="btn btn-sm btn-outline-primary present-illness-btn" data-illness="症狀程度: 逐漸加重" data-target="presentIllness">逐漸加重</button>
                                <button type="button" class="btn btn-sm btn-outline-primary present-illness-btn" data-illness="症狀程度: 間歇性發作" data-target="presentIllness">間歇性發作</button>
                                <button type="button" class="btn btn-sm btn-outline-primary present-illness-btn" data-illness="緩解因素: 休息後改善" data-target="presentIllness">休息後改善</button>
                                <button type="button" class="btn btn-sm btn-outline-primary present-illness-btn" data-illness="加重因素: 活動後加重" data-target="presentIllness">活動後加重</button>
                                <button type="button" class="btn btn-sm btn-outline-primary present-illness-btn" data-illness="相關治療: 自行服用藥物無效" data-target="presentIllness">自行用藥無效</button>
                                <button type="button" class="btn btn-sm btn-outline-primary present-illness-btn" data-illness="病史發展: 近期有類似症狀病史" data-target="presentIllness">近期有類似症狀</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="physical_examination" class="form-label">伴隨症狀與體格檢查（PE）</label>
                            <textarea class="form-control mb-2" id="physical_examination" name="physical_examination" rows="3" placeholder="輸入伴隨症狀和重要體格檢查發現..."></textarea>
                            <!-- 伴隨症狀與PE按鈕 -->
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary symptom-pe-btn" data-symptom-pe="發燒 (38.5°C)" data-target="physical_examination">發燒</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary symptom-pe-btn" data-symptom-pe="胸痛 (壓迫感)" data-target="physical_examination">胸痛</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary symptom-pe-btn" data-symptom-pe="呼吸急促" data-target="physical_examination">呼吸急促</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary symptom-pe-btn" data-symptom-pe="盜汗" data-target="physical_examination">盜汗</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary symptom-pe-btn" data-symptom-pe="肺部濕囉音" data-target="physical_examination">肺部濕囉音</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary symptom-pe-btn" data-symptom-pe="腹部壓痛" data-target="physical_examination">腹部壓痛</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary symptom-pe-btn" data-symptom-pe="頸部僵硬" data-target="physical_examination">頸部僵硬</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="pastHistory" class="form-label">過去病史</label>
                            <textarea class="form-control mb-2" id="pastHistory" name="pastHistory" rows="2" placeholder="輸入過去病史..."></textarea>
                            <!-- 過去病史按鈕 -->
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-info past-history-btn" data-history="高血壓" data-target="pastHistory">高血壓</button>
                                <button type="button" class="btn btn-sm btn-outline-info past-history-btn" data-history="糖尿病" data-target="pastHistory">糖尿病</button>
                                <button type="button" class="btn btn-sm btn-outline-info past-history-btn" data-history="高血脂" data-target="pastHistory">高血脂</button>
                                <button type="button" class="btn btn-sm btn-outline-info past-history-btn" data-history="冠心病" data-target="pastHistory">冠心病</button>
                                <button type="button" class="btn btn-sm btn-outline-info past-history-btn" data-history="腎功能不全" data-target="pastHistory">腎功能不全</button>
                                <button type="button" class="btn btn-sm btn-outline-info past-history-btn" data-history="甲狀腺功能低下" data-target="pastHistory">甲狀腺功能低下</button>
                                <button type="button" class="btn btn-sm btn-outline-info past-history-btn" data-history="肺炎" data-target="pastHistory">肺炎</button>
                                <button type="button" class="btn btn-sm btn-outline-info past-history-btn" data-history="氣喘" data-target="pastHistory">氣喘</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="medications" class="form-label">目前用藥</label>
                            <textarea class="form-control mb-2" id="medications" name="medications" rows="2" placeholder="輸入目前用藥..."></textarea>
                            <!-- 目前用藥按鈕 -->
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-primary medication-btn" data-medication="降壓藥" data-target="medications">降壓藥</button>
                                <button type="button" class="btn btn-sm btn-outline-primary medication-btn" data-medication="口服降糖藥" data-target="medications">口服降糖藥</button>
                                <button type="button" class="btn btn-sm btn-outline-primary medication-btn" data-medication="胰島素" data-target="medications">胰島素</button>
                                <button type="button" class="btn btn-sm btn-outline-primary medication-btn" data-medication="阿司匹林" data-target="medications">阿司匹林</button>
                                <button type="button" class="btn btn-sm btn-outline-primary medication-btn" data-medication="他汀類藥物" data-target="medications">他汀類藥物</button>
                                <button type="button" class="btn btn-sm btn-outline-primary medication-btn" data-medication="甲狀腺素" data-target="medications">甲狀腺素</button>
                                <button type="button" class="btn btn-sm btn-outline-primary medication-btn" data-medication="抗生素" data-target="medications">抗生素</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="allergies" class="form-label">過敏史</label>
                            <textarea class="form-control mb-2" id="allergies" name="allergies" rows="1" placeholder="輸入過敏史..."></textarea>
                            <!-- 過敏史按鈕 -->
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-danger allergy-btn" data-allergy="青黴素過敏" data-target="allergies">青黴素</button>
                                <button type="button" class="btn btn-sm btn-outline-danger allergy-btn" data-allergy="磺胺類藥物過敏" data-target="allergies">磺胺類</button>
                                <button type="button" class="btn btn-sm btn-outline-danger allergy-btn" data-allergy="海鮮過敏" data-target="allergies">海鮮</button>
                                <button type="button" class="btn btn-sm btn-outline-danger allergy-btn" data-allergy="花粉過敏" data-target="allergies">花粉</button>
                                <button type="button" class="btn btn-sm btn-outline-danger allergy-btn" data-allergy="季節性過敏" data-target="allergies">季節性</button>
                                <button type="button" class="btn btn-sm btn-outline-danger allergy-btn" data-allergy="無已知過敏" data-target="allergies">無已知過敏</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="familyHistory" class="form-label">家族史</label>
                            <textarea class="form-control mb-2" id="familyHistory" name="familyHistory" rows="2" placeholder="輸入家族史..."></textarea>
                            <!-- 家族史按鈕 -->
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary family-history-btn" data-family-history="父親高血壓" data-target="familyHistory">父親高血壓</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary family-history-btn" data-family-history="母親糖尿病" data-target="familyHistory">母親糖尿病</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary family-history-btn" data-family-history="心血管疾病家族史" data-target="familyHistory">心血管疾病</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary family-history-btn" data-family-history="癌症家族史" data-target="familyHistory">癌症</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary family-history-btn" data-family-history="無特殊家族史" data-target="familyHistory">無特殊家族史</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="socialHistory" class="form-label">社會史</label>
                            <textarea class="form-control mb-2" id="socialHistory" name="socialHistory" rows="2" placeholder="輸入社會史..."></textarea>
                            <!-- 社會史按鈕 -->
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary social-history-btn" data-social-history="吸菸" data-target="socialHistory">吸菸</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary social-history-btn" data-social-history="飲酒" data-target="socialHistory">飲酒</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary social-history-btn" data-social-history="藥物濫用" data-target="socialHistory">藥物濫用</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary social-history-btn" data-social-history="無業" data-target="socialHistory">無業</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary social-history-btn" data-social-history="退休" data-target="socialHistory">退休</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary social-history-btn" data-social-history="已婚" data-target="socialHistory">已婚</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary social-history-btn" data-social-history="獨居" data-target="socialHistory">獨居</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">包含部分</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="chief_complaint" id="includeChiefComplaint" name="includeSections" checked disabled>
                                        <label class="form-check-label" for="includeChiefComplaint">
                                            主訴
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="history_present_illness" id="includeHPI" name="includeSections" checked>
                                        <label class="form-check-label" for="includeHPI">
                                            現病史
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="past_medical_history" id="includePMH" name="includeSections" checked>
                                        <label class="form-check-label" for="includePMH">
                                            過去病史
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="medications" id="includeMeds" name="includeSections" checked>
                                        <label class="form-check-label" for="includeMeds">
                                            目前用藥
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="allergies" id="includeAllergies" name="includeSections" checked>
                                        <label class="form-check-label" for="includeAllergies">
                                            過敏史
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="family_history" id="includeFamHx" name="includeSections" checked>
                                        <label class="form-check-label" for="includeFamHx">
                                            家族史
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="social_history" id="includeSocHx" name="includeSections" checked>
                                        <label class="form-check-label" for="includeSocHx">
                                            社會史
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="physical_examination" id="includePhysExam" name="includeSections" checked>
                                        <label class="form-check-label" for="includePhysExam">
                                            身體檢查
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="vital_signs" id="includeVitals" name="includeSections" checked>
                                        <label class="form-check-label" for="includeVitals">
                                            生命徵象
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="laboratory_results" id="includeLabs" name="includeSections" checked>
                                        <label class="form-check-label" for="includeLabs">
                                            實驗室檢查
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="assessment" id="includeAssessment" name="includeSections" checked>
                                        <label class="form-check-label" for="includeAssessment">
                                            評估
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="plan" id="includePlan" name="includeSections" checked>
                                        <label class="form-check-label" for="includePlan">
                                            計劃
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="labComplexity" class="form-label">實驗室檢查詳細度</label>
                            <select class="form-select mb-2" id="labComplexity" name="labComplexity">
                                <option value="基本">基本 (CBC, 基本生化)</option>
                                <option value="中等" selected>中等 (CBC, CMP, 電解質, 尿檢)</option>
                                <option value="詳細">詳細 (詳細生化, 特殊檢查)</option>
                                <option value="全面">全面 (包含所有可能相關檢查)</option>
                            </select>
                            
                            <!-- 實驗室檢查規模按鈕 -->
                            <div class="d-flex flex-wrap gap-1 mt-2">
                                <button type="button" class="btn btn-sm btn-outline-info lab-complexity-btn" data-complexity="基本">基本</button>
                                <button type="button" class="btn btn-sm btn-outline-info lab-complexity-btn" data-complexity="中等">中等</button>
                                <button type="button" class="btn btn-sm btn-outline-info lab-complexity-btn" data-complexity="詳細">詳細</button>
                                <button type="button" class="btn btn-sm btn-outline-info lab-complexity-btn" data-complexity="全面">全面</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="templateSelect" class="form-label">使用範本</label>
                            <select class="form-select mb-2" id="templateSelect">
                                <option value="">不使用範本</option>
                                <option value="internal-med">內科常見</option>
                                <option value="cardiology">心臟科常見</option>
                                <option value="gastroenterology">腸胃科常見</option>
                                <option value="pulmonology">呼吸科常見</option>
                                <option value="er">急診常見</option>
                            </select>
                        </div>
                        
                        <div class="mb-3 d-none" id="advancedOptionsSection">
                            <label class="form-label">高級選項</label>
                            <div class="form-floating mb-3">
                                <textarea class="form-control" id="systemMessage" style="height: 100px"></textarea>
                                <label for="systemMessage">系統訊息</label>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="temperature" class="form-label">Temperature</label>
                                    <input type="number" class="form-control" id="temperature" value="0.7" min="0" max="2" step="0.1">
                                </div>
                                <div class="col-md-3">
                                    <label for="maxTokens" class="form-label">最大 Tokens</label>
                                    <input type="number" class="form-control" id="maxTokens" value="2000" min="500" max="4000" step="100">
                                </div>
                                <div class="col-md-6">
                                    <label for="modelSelect" class="form-label">模型</label>
                                    <select class="form-select" id="modelSelect">
                                        <option value="gpt-4o" selected>gpt-4o (最新)</option>
                                        <option value="gpt-4">gpt-4</option>
                                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-link" id="toggleAdvancedBtn">
                                <i class="fas fa-cog me-1"></i> 高級選項
                            </button>
                            <div>
                                <button type="reset" class="btn btn-secondary">
                                    <i class="fas fa-undo me-1"></i> 重置
                                </button>
                                <button type="submit" class="btn btn-primary" id="generateBtn">
                                    <i class="fas fa-file-medical me-1"></i> 生成病例
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Case Results Section -->
    <div class="row mb-4 d-none" id="resultSection">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">生成結果</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="printCaseBtn">
                            <i class="fas fa-print me-1"></i> 列印
                        </button>
                        <button class="btn btn-sm btn-outline-primary" id="copyCaseBtn">
                            <i class="fas fa-copy me-1"></i> 複製
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info d-none" id="generatingAlert">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>生成病例中，請稍候...</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-danger d-none" id="errorAlert"></div>
                    
                    <div id="caseResult" class="d-none">
                        <h3 id="caseTitle" class="mb-4 text-center"></h3>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">患者資訊</h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <tr>
                                                <th width="30%">年齡:</th>
                                                <td id="resultAge"></td>
                                            </tr>
                                            <tr>
                                                <th>性別:</th>
                                                <td id="resultGender"></td>
                                            </tr>
                                            <tr>
                                                <th>主訴:</th>
                                                <td id="resultChiefComplaint"></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">案例詳情</h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm">
                                            <tr>
                                                <th width="30%">專科:</th>
                                                <td id="resultSpecialty"></td>
                                            </tr>
                                            <tr>
                                                <th>複雜度:</th>
                                                <td id="resultComplexity"></td>
                                            </tr>
                                            <tr>
                                                <th>生成時間:</th>
                                                <td id="resultTimestamp"></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion" id="caseContentAccordion">
                            <!-- Sections will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Cases Section -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">最近生成的病例</h5>
                    <a href="{{ url_for('list_cases') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-list me-1"></i> 所有病例
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_cases %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>標題</th>
                                        <th>專科</th>
                                        <th>主訴</th>
                                        <th>生成時間</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for case in recent_cases %}
                                        <tr>
                                            <td>{{ case.title }}</td>
                                            <td>{{ case.specialty.name if case.specialty else "未指定" }}</td>
                                            <td>{{ case.chief_complaint }}</td>
                                            <td>{{ case.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td>
                                                <a href="{{ url_for('view_case', id=case.id) }}" class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> 尚未生成任何病例。使用上方表單生成您的第一個病例。
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/medical.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle advanced options
    const toggleAdvancedBtn = document.getElementById('toggleAdvancedBtn');
    const advancedOptionsSection = document.getElementById('advancedOptionsSection');
    
    toggleAdvancedBtn.addEventListener('click', function() {
        advancedOptionsSection.classList.toggle('d-none');
        toggleAdvancedBtn.innerHTML = advancedOptionsSection.classList.contains('d-none') 
            ? '<i class="fas fa-cog me-1"></i> 高級選項' 
            : '<i class="fas fa-cog me-1"></i> 隱藏高級選項';
    });
    
    // Common complaints dropdown
    const complaintItems = document.querySelectorAll('[data-complaint]');
    const chiefComplaintInput = document.getElementById('chiefComplaint');
    
    complaintItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            chiefComplaintInput.value = this.getAttribute('data-complaint');
        });
    });
    
    // Present Illness Generation
    const generatePresentIllnessBtn = document.getElementById('generatePresentIllnessBtn');
    const presentIllnessTextarea = document.getElementById('presentIllness');
    const generatingPresentIllnessAlert = document.getElementById('generatingPresentIllnessAlert');
    const presentIllnessErrorAlert = document.getElementById('presentIllnessErrorAlert');
    
    if (generatePresentIllnessBtn) {
        generatePresentIllnessBtn.addEventListener('click', function() {
            // Get necessary values
            const chiefComplaint = document.getElementById('chiefComplaint').value;
            const patientAge = document.getElementById('patientAge').value;
            const patientGender = document.getElementById('patientGender').value;
            const accompaniedSymptoms = document.getElementById('accompaniedSymptoms')?.value || '';
            
            // Validate chief complaint
            if (!chiefComplaint) {
                presentIllnessErrorAlert.textContent = '請先輸入主訴';
                presentIllnessErrorAlert.classList.remove('d-none');
                setTimeout(() => {
                    presentIllnessErrorAlert.classList.add('d-none');
                }, 3000);
                return;
            }
            
            // Show loading state
            generatingPresentIllnessAlert.classList.remove('d-none');
            presentIllnessErrorAlert.classList.add('d-none');
            generatePresentIllnessBtn.disabled = true;
            
            // Collect any existing details from the textarea
            const presentIllnessDetails = presentIllnessTextarea.value;
            
            // Prepare data to send
            const formData = {
                chief_complaint: chiefComplaint,
                patient_age: patientAge,
                patient_gender: patientGender,
                accompanied_symptoms: accompaniedSymptoms,
                present_illness_details: presentIllnessDetails
            };
            
            // Send the request to generate present illness
            fetch('/medical/generate-present-illness', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading state
                generatingPresentIllnessAlert.classList.add('d-none');
                generatePresentIllnessBtn.disabled = false;
                
                if (data.success) {
                    // Update the textarea with the generated content
                    presentIllnessTextarea.value = data.result.present_illness;
                } else {
                    // Show error message
                    presentIllnessErrorAlert.textContent = data.message || '生成現病史時發生錯誤';
                    presentIllnessErrorAlert.classList.remove('d-none');
                }
            })
            .catch(error => {
                // Hide loading state
                generatingPresentIllnessAlert.classList.add('d-none');
                generatePresentIllnessBtn.disabled = false;
                
                // Show error message
                presentIllnessErrorAlert.textContent = '請求發生錯誤: ' + error.message;
                presentIllnessErrorAlert.classList.remove('d-none');
            });
        });
    }

    // Handle form submission
    const caseGeneratorForm = document.getElementById('caseGeneratorForm');
    const generateBtn = document.getElementById('generateBtn');
    const resultSection = document.getElementById('resultSection');
    const generatingAlert = document.getElementById('generatingAlert');
    const errorAlert = document.getElementById('errorAlert');
    const caseResult = document.getElementById('caseResult');
    
    caseGeneratorForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        resultSection.classList.remove('d-none');
        generatingAlert.classList.remove('d-none');
        errorAlert.classList.add('d-none');
        caseResult.classList.add('d-none');
        generateBtn.disabled = true;
        
        // Get form values
        const specialty = document.getElementById('specialty').value;
        const chiefComplaint = document.getElementById('chiefComplaint').value;
        const patientAge = document.getElementById('patientAge').value;
        const patientGender = document.getElementById('patientGender').value;
        const complexity = document.getElementById('complexity').value;
        const saveCase = document.getElementById('saveCase').checked;
        const labComplexity = document.getElementById('labComplexity').value;
        
        // Get selected sections
        const includeSections = [];
        document.querySelectorAll('input[name="includeSections"]:checked').forEach(checkbox => {
            includeSections.push(checkbox.value);
        });
        
        // Get advanced options
        const systemMessage = document.getElementById('systemMessage').value;
        const temperature = parseFloat(document.getElementById('temperature').value);
        const maxTokens = parseInt(document.getElementById('maxTokens').value);
        const model = document.getElementById('modelSelect').value;
        
        // Add lab complexity to system message
        let enhancedSystemMessage = systemMessage;
        if (labComplexity && includeSections.includes('laboratory_results')) {
            if (enhancedSystemMessage) enhancedSystemMessage += "\n\n";
            enhancedSystemMessage += `實驗室檢查的詳細度: ${labComplexity}。`;
            
            if (labComplexity === '基本') {
                enhancedSystemMessage += "包含基本的血液計數和生化檢查。";
            } else if (labComplexity === '中等') {
                enhancedSystemMessage += "包含全血計數、全套生化檢查、電解質和尿液分析。";
            } else if (labComplexity === '詳細') {
                enhancedSystemMessage += "包含詳細的生化指標、特殊測試和相關專科檢查。";
            } else if (labComplexity === '全面') {
                enhancedSystemMessage += "包含所有可能相關的實驗室檢查，全面且詳細的數值和參考範圍。";
            }
        }
        
        // Prepare data to send
        const formData = {
            specialty: specialty,
            chief_complaint: chiefComplaint,
            patient_age: patientAge,
            patient_gender: patientGender,
            complexity: complexity,
            include_sections: includeSections,
            save: saveCase,
            model: model,
            system_message: enhancedSystemMessage,
            temperature: temperature,
            max_tokens: maxTokens
        };
        
        // Send the data
        fetch('/medical/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            // Hide loading state
            generatingAlert.classList.add('d-none');
            generateBtn.disabled = false;
            
            if (data.success) {
                displayCaseResult(data.result);
            } else {
                // Show error message
                errorAlert.textContent = data.message || '生成病例時發生錯誤。';
                errorAlert.classList.remove('d-none');
            }
        })
        .catch(error => {
            // Hide loading state
            generatingAlert.classList.add('d-none');
            generateBtn.disabled = false;
            
            // Show error message
            errorAlert.textContent = '請求發生錯誤: ' + error.message;
            errorAlert.classList.remove('d-none');
        });
    });
    
    // Function to display the case result
    function displayCaseResult(result) {
        caseResult.classList.remove('d-none');
        const caseData = result.case;
        const metadata = result.metadata;
        
        // Set basic information
        document.getElementById('caseTitle').textContent = caseData.title;
        document.getElementById('resultAge').textContent = metadata.parameters.patient_age;
        document.getElementById('resultGender').textContent = metadata.parameters.patient_gender;
        document.getElementById('resultChiefComplaint').textContent = caseData.chief_complaint || metadata.parameters.chief_complaint;
        document.getElementById('resultSpecialty').textContent = metadata.parameters.specialty || '未指定';
        document.getElementById('resultComplexity').textContent = metadata.parameters.complexity;
        
        // Format timestamp
        const timestamp = new Date(metadata.generated_at);
        document.getElementById('resultTimestamp').textContent = timestamp.toLocaleString();
        
        // Clear any existing sections
        const accordion = document.getElementById('caseContentAccordion');
        accordion.innerHTML = '';
        
        // Add each section to the accordion
        const sections = [
            { id: 'chief_complaint', title: '主訴' },
            { id: 'history_present_illness', title: '現病史' },
            { id: 'past_medical_history', title: '過去病史' },
            { id: 'medications', title: '目前用藥' },
            { id: 'allergies', title: '過敏史' },
            { id: 'family_history', title: '家族史' },
            { id: 'social_history', title: '社會史' },
            { id: 'physical_examination', title: '身體檢查' },
            { id: 'vital_signs', title: '生命徵象' },
            { id: 'laboratory_results', title: '實驗室檢查' },
            { id: 'imaging_results', title: '影像學檢查' },
            { id: 'assessment', title: '評估' },
            { id: 'plan', title: '計劃' }
        ];
        
        sections.forEach((section, index) => {
            // Skip if section is not in the result
            if (!caseData[section.id]) return;
            
            const sectionId = `section_${section.id}`;
            const headerId = `heading_${section.id}`;
            const collapseId = `collapse_${section.id}`;
            
            const item = document.createElement('div');
            item.className = 'accordion-item';
            
            item.innerHTML = `
                <h2 class="accordion-header" id="${headerId}">
                    <button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${index === 0}" aria-controls="${collapseId}">
                        ${section.title}
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" aria-labelledby="${headerId}" data-bs-parent="#caseContentAccordion">
                    <div class="accordion-body">
                        <div id="${sectionId}">
                            ${caseData[section.id].replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
            `;
            
            accordion.appendChild(item);
        });
        
        // Set up print button
        document.getElementById('printCaseBtn').addEventListener('click', function() {
            printCase(caseData, metadata);
        });
        
        // Set up copy button
        document.getElementById('copyCaseBtn').addEventListener('click', function() {
            copyCase(caseData, metadata);
        });
    }
    
    // Function to print the case
    function printCase(caseData, metadata) {
        const printWindow = window.open('', '_blank');
        let printContent = `
            <html>
            <head>
                <title>${caseData.title || '醫療病例'}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { text-align: center; margin-bottom: 20px; }
                    .section { margin-bottom: 15px; }
                    .section-title { font-weight: bold; margin-bottom: 5px; }
                    .patient-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
                    .info-group { width: 48%; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { padding: 5px; text-align: left; border-bottom: 1px solid #ddd; }
                    th { width: 30%; }
                </style>
            </head>
            <body>
                <h1>${caseData.title || '醫療病例'}</h1>
                
                <div class="patient-info">
                    <div class="info-group">
                        <table>
                            <tr>
                                <th>年齡:</th>
                                <td>${metadata.parameters.patient_age}</td>
                            </tr>
                            <tr>
                                <th>性別:</th>
                                <td>${metadata.parameters.patient_gender}</td>
                            </tr>
                            <tr>
                                <th>主訴:</th>
                                <td>${caseData.chief_complaint || metadata.parameters.chief_complaint}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="info-group">
                        <table>
                            <tr>
                                <th>專科:</th>
                                <td>${metadata.parameters.specialty || '未指定'}</td>
                            </tr>
                            <tr>
                                <th>複雜度:</th>
                                <td>${metadata.parameters.complexity}</td>
                            </tr>
                            <tr>
                                <th>生成時間:</th>
                                <td>${new Date(metadata.generated_at).toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>
                </div>
        `;
        
        const sections = [
            { id: 'chief_complaint', title: '主訴' },
            { id: 'history_present_illness', title: '現病史' },
            { id: 'past_medical_history', title: '過去病史' },
            { id: 'medications', title: '目前用藥' },
            { id: 'allergies', title: '過敏史' },
            { id: 'family_history', title: '家族史' },
            { id: 'social_history', title: '社會史' },
            { id: 'physical_examination', title: '身體檢查' },
            { id: 'vital_signs', title: '生命徵象' },
            { id: 'laboratory_results', title: '實驗室檢查' },
            { id: 'imaging_results', title: '影像學檢查' },
            { id: 'assessment', title: '評估' },
            { id: 'plan', title: '計劃' }
        ];
        
        sections.forEach(section => {
            if (caseData[section.id]) {
                printContent += `
                    <div class="section">
                        <div class="section-title">${section.title}</div>
                        <div>${caseData[section.id].replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            }
        });
        
        printContent += `
            </body>
            </html>
        `;
        
        printWindow.document.open();
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.print();
        };
    }
    
    // Function to copy the case to clipboard
    function copyCase(caseData, metadata) {
        let copyContent = `${caseData.title || '醫療病例'}\n\n`;
        
        copyContent += `患者資訊:\n`;
        copyContent += `年齡: ${metadata.parameters.patient_age}\n`;
        copyContent += `性別: ${metadata.parameters.patient_gender}\n`;
        copyContent += `主訴: ${caseData.chief_complaint || metadata.parameters.chief_complaint}\n\n`;
        
        const sections = [
            { id: 'chief_complaint', title: '主訴' },
            { id: 'history_present_illness', title: '現病史' },
            { id: 'past_medical_history', title: '過去病史' },
            { id: 'medications', title: '目前用藥' },
            { id: 'allergies', title: '過敏史' },
            { id: 'family_history', title: '家族史' },
            { id: 'social_history', title: '社會史' },
            { id: 'physical_examination', title: '身體檢查' },
            { id: 'vital_signs', title: '生命徵象' },
            { id: 'laboratory_results', title: '實驗室檢查' },
            { id: 'imaging_results', title: '影像學檢查' },
            { id: 'assessment', title: '評估' },
            { id: 'plan', title: '計劃' }
        ];
        
        sections.forEach(section => {
            if (caseData[section.id]) {
                copyContent += `${section.title}:\n${caseData[section.id]}\n\n`;
            }
        });
        
        navigator.clipboard.writeText(copyContent).then(() => {
            alert('病例已複製到剪貼簿');
        }).catch(err => {
            console.error('無法複製: ', err);
            alert('複製失敗，請手動選擇並複製');
        });
    }
    
    // Templates handling
    const templateSelect = document.getElementById('templateSelect');
    
    templateSelect.addEventListener('change', function() {
        const templateId = this.value;
        if (!templateId) return;
        
        // Set form values based on template
        if (templateId === 'internal-med') {
            document.getElementById('specialty').value = '內科';
            document.getElementById('labComplexity').value = '中等';
            document.getElementById('systemMessage').value = '生成一個典型的內科病例，包含合理的實驗室結果和身體檢查發現。使用明確的病歷格式，並包含足夠的細節使病例現實可信。';
        } else if (templateId === 'cardiology') {
            document.getElementById('specialty').value = '心臟科';
            document.getElementById('labComplexity').value = '詳細';
            document.getElementById('systemMessage').value = '生成一個詳細的心臟科病例，包含心電圖、心臟酶學和超聲心動圖結果。確保生命體徵包含詳細的心臟檢查結果。';
        } else if (templateId === 'gastroenterology') {
            document.getElementById('specialty').value = '腸胃科';
            document.getElementById('labComplexity').value = '詳細';
            document.getElementById('systemMessage').value = '生成一個腸胃科病例，包含詳細的腹部檢查、消化系統症狀描述和肝功能檢測結果。若適用，請加入內窺鏡結果。';
        } else if (templateId === 'pulmonology') {
            document.getElementById('specialty').value = '呼吸科';
            document.getElementById('labComplexity').value = '詳細';
            document.getElementById('systemMessage').value = '生成一個呼吸科病例，包含詳細的呼吸系統檢查、肺功能測試和胸部影像學檢查結果。確保包含準確的呼吸聲和氧飽和度。';
        } else if (templateId === 'er') {
            document.getElementById('specialty').value = '急診醫學';
            document.getElementById('labComplexity').value = '全面';
            document.getElementById('systemMessage').value = '生成一個急診醫學病例，強調快速評估和初步處理。包含完整的ABCDE評估和急診重要生命徵象。';
        }
        
        // Show advanced options to display system message
        advancedOptionsSection.classList.remove('d-none');
        toggleAdvancedBtn.innerHTML = '<i class="fas fa-cog me-1"></i> 隱藏高級選項';
    });
});
</script>
{% endblock %}