{% extends 'layout.html' %}

{% block content %}
<div class="container py-4">
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <h1>推薦問診與體檢項目</h1>
        <div>
            <button class="btn btn-outline-primary" id="saveQuestionsBtn">
                <i class="fas fa-save me-1"></i> 儲存問診單
            </button>
            <a href="{{ url_for('view_case', id=case.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> 返回病例
            </a>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">病患資訊</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="30%">年齡:</th>
                            <td>{{ case.patient_age }}</td>
                        </tr>
                        <tr>
                            <th>性別:</th>
                            <td>{{ case.patient_gender }}</td>
                        </tr>
                        <tr>
                            <th>主訴:</th>
                            <td>{{ case.chief_complaint }}</td>
                        </tr>
                        <tr>
                            <th>專科:</th>
                            <td>{{ case.specialty.name if case.specialty else "未指定" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">問診指導</h5>
                </div>
                <div class="card-body">
                    <p>
                        <i class="fas fa-info-circle text-info me-2"></i> 
                        以下是系統根據病患資訊自動生成的推薦問診和體檢項目。您可以勾選需要的項目，也可以添加自訂問診。
                    </p>
                    <p>
                        <button class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                            <i class="fas fa-check-square me-1"></i> 全選
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">
                            <i class="fas fa-square me-1"></i> 取消全選
                        </button>
                        <button class="btn btn-sm btn-outline-success" id="generateAudioBtn">
                            <i class="fas fa-microphone me-1"></i> 語音提示模式
                        </button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 推薦問診項目 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">推薦問診項目</h5>
                    <button class="btn btn-sm btn-outline-primary" id="addCustomQuestionBtn">
                        <i class="fas fa-plus me-1"></i> 添加自訂問題
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="recommendedQuestions">
                        {% for question in recommended_questions %}
                        <div class="list-group-item">
                            <div class="form-check d-flex justify-content-between align-items-center">
                                <div>
                                    <input class="form-check-input question-checkbox" type="checkbox" value="{{ question }}" id="question{{ loop.index }}">
                                    <label class="form-check-label" for="question{{ loop.index }}">
                                        {{ question }}
                                    </label>
                                </div>
                                <div class="question-buttons">
                                    <button class="btn btn-sm btn-link text-info edit-question-btn" data-question-id="{{ loop.index }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-link text-danger delete-question-btn" data-question-id="{{ loop.index }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">推薦體檢項目</h5>
                    <button class="btn btn-sm btn-outline-primary" id="addCustomExamBtn">
                        <i class="fas fa-plus me-1"></i> 添加自訂體檢
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="recommendedExams">
                        {% for exam in recommended_exams %}
                        <div class="list-group-item">
                            <div class="form-check d-flex justify-content-between align-items-center">
                                <div>
                                    <input class="form-check-input exam-checkbox" type="checkbox" value="{{ exam }}" id="exam{{ loop.index }}">
                                    <label class="form-check-label" for="exam{{ loop.index }}">
                                        {{ exam }}
                                    </label>
                                </div>
                                <div class="exam-buttons">
                                    <button class="btn btn-sm btn-link text-info edit-exam-btn" data-exam-id="{{ loop.index }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-link text-danger delete-exam-btn" data-exam-id="{{ loop.index }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 問診流程指南 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">問診流程建議</h5>
        </div>
        <div class="card-body">
            <div id="questionnaireFlow">
                {{ questionnaire_flow | safe }}
            </div>
        </div>
    </div>
    
    <!-- 儲存的問診計劃 -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">已選擇的項目</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>問診項目</h6>
                    <ul id="selectedQuestions" class="list-group">
                        <!-- JavaScript 將在這裡顯示選中的問診項目 -->
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>體檢項目</h6>
                    <ul id="selectedExams" class="list-group">
                        <!-- JavaScript 將在這裡顯示選中的體檢項目 -->
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-footer text-end">
            <button class="btn btn-outline-primary" id="exportSelectedBtn">
                <i class="fas fa-file-export me-1"></i> 匯出問診計劃
            </button>
            <button class="btn btn-primary" id="saveSelectedBtn">
                <i class="fas fa-save me-1"></i> 儲存問診計劃
            </button>
        </div>
    </div>
    
    <!-- 新增問題模態框 -->
    <div class="modal fade" id="addQuestionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="questionModalTitle">新增自訂問題</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="questionForm">
                        <input type="hidden" id="questionEditIndex" value="-1">
                        <div class="mb-3">
                            <label for="questionText" class="form-label">問題內容</label>
                            <textarea class="form-control" id="questionText" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="questionCategory" class="form-label">類別</label>
                            <select class="form-select" id="questionCategory">
                                <option value="問診">問診</option>
                                <option value="體檢">體檢</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveQuestionBtn">儲存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 語音提示模式模態框 -->
    <div class="modal fade" id="audioModeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">語音提示模式</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="current-question p-3 border rounded mb-3">
                            <h4 id="currentQuestion">按下「開始問診」按鈕開始</h4>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" id="startQuestioning">
                                <i class="fas fa-play me-1"></i> 開始問診
                            </button>
                            <button class="btn btn-secondary" id="previousQuestion" disabled>
                                <i class="fas fa-step-backward me-1"></i> 上一題
                            </button>
                            <button class="btn btn-secondary" id="nextQuestion" disabled>
                                <i class="fas fa-step-forward me-1"></i> 下一題
                            </button>
                            <button class="btn btn-danger" id="stopQuestioning" disabled>
                                <i class="fas fa-stop me-1"></i> 停止問診
                            </button>
                        </div>
                    </div>
                    <div class="text-center mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="autoAdvanceCheck" value="option1">
                            <label class="form-check-label" for="autoAdvanceCheck">自動前進 (10秒)</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="textToSpeechCheck" value="option2" checked>
                            <label class="form-check-label" for="textToSpeechCheck">語音朗讀問題</label>
                        </div>
                    </div>
                    <div class="progress mb-3" style="height: 20px;">
                        <div id="questionProgress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <div class="upcoming-questions border p-2 rounded">
                        <h6>即將進行的問題：</h6>
                        <ol id="upcomingQuestions" class="mb-0">
                            <!-- JavaScript 將填充這裡 -->
                        </ol>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-success" id="completeQuestioning">
                        <i class="fas fa-check me-1"></i> 完成問診
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 選擇/取消選擇所有項目
    document.getElementById('selectAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.question-checkbox, .exam-checkbox').forEach(checkbox => {
            checkbox.checked = true;
            updateSelectedItems();
        });
    });
    
    document.getElementById('deselectAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.question-checkbox, .exam-checkbox').forEach(checkbox => {
            checkbox.checked = false;
            updateSelectedItems();
        });
    });
    
    // 監聽勾選框變化
    document.querySelectorAll('.question-checkbox, .exam-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedItems();
        });
    });
    
    // 添加自訂問題按鈕
    document.getElementById('addCustomQuestionBtn').addEventListener('click', function() {
        document.getElementById('questionModalTitle').textContent = '新增自訂問題';
        document.getElementById('questionCategory').value = '問診';
        document.getElementById('questionEditIndex').value = '-1';
        document.getElementById('questionText').value = '';
        const modal = new bootstrap.Modal(document.getElementById('addQuestionModal'));
        modal.show();
    });
    
    // 添加自訂體檢按鈕
    document.getElementById('addCustomExamBtn').addEventListener('click', function() {
        document.getElementById('questionModalTitle').textContent = '新增自訂體檢項目';
        document.getElementById('questionCategory').value = '體檢';
        document.getElementById('questionEditIndex').value = '-1';
        document.getElementById('questionText').value = '';
        const modal = new bootstrap.Modal(document.getElementById('addQuestionModal'));
        modal.show();
    });
    
    // 儲存自訂問題
    document.getElementById('saveQuestionBtn').addEventListener('click', function() {
        const questionText = document.getElementById('questionText').value.trim();
        const category = document.getElementById('questionCategory').value;
        const editIndex = document.getElementById('questionEditIndex').value;
        
        if (!questionText) return;
        
        const container = category === '問診' ? document.getElementById('recommendedQuestions') : document.getElementById('recommendedExams');
        
        if (editIndex === '-1') {
            // 新增項目
            const itemCount = container.querySelectorAll('.list-group-item').length + 1;
            const itemId = category === '問診' ? `question${itemCount}` : `exam${itemCount}`;
            const checkboxClass = category === '問診' ? 'question-checkbox' : 'exam-checkbox';
            
            const newItem = document.createElement('div');
            newItem.className = 'list-group-item';
            newItem.innerHTML = `
                <div class="form-check d-flex justify-content-between align-items-center">
                    <div>
                        <input class="form-check-input ${checkboxClass}" type="checkbox" value="${questionText}" id="${itemId}">
                        <label class="form-check-label" for="${itemId}">
                            ${questionText}
                        </label>
                    </div>
                    <div class="${category === '問診' ? 'question' : 'exam'}-buttons">
                        <button class="btn btn-sm btn-link text-info edit-${category === '問診' ? 'question' : 'exam'}-btn" data-${category === '問診' ? 'question' : 'exam'}-id="${itemCount}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-link text-danger delete-${category === '問診' ? 'question' : 'exam'}-btn" data-${category === '問診' ? 'question' : 'exam'}-id="${itemCount}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(newItem);
            
            // 為新項目添加事件監聽器
            const newCheckbox = newItem.querySelector(`.${checkboxClass}`);
            newCheckbox.addEventListener('change', updateSelectedItems);
            
            const editBtn = newItem.querySelector(`.edit-${category === '問診' ? 'question' : 'exam'}-btn`);
            editBtn.addEventListener('click', handleEditItem);
            
            const deleteBtn = newItem.querySelector(`.delete-${category === '問診' ? 'question' : 'exam'}-btn`);
            deleteBtn.addEventListener('click', handleDeleteItem);
        } else {
            // 編輯現有項目
            const itemIdPrefix = category === '問診' ? 'question' : 'exam';
            const item = document.getElementById(`${itemIdPrefix}${editIndex}`);
            if (item) {
                item.value = questionText;
                const label = item.nextElementSibling;
                label.textContent = questionText;
            }
        }
        
        bootstrap.Modal.getInstance(document.getElementById('addQuestionModal')).hide();
        updateSelectedItems();
    });
    
    // 編輯問題
    function handleEditItem(e) {
        const category = e.currentTarget.classList.contains('edit-question-btn') ? '問診' : '體檢';
        const itemId = category === '問診' 
            ? e.currentTarget.getAttribute('data-question-id')
            : e.currentTarget.getAttribute('data-exam-id');
        
        const itemIdPrefix = category === '問診' ? 'question' : 'exam';
        const item = document.getElementById(`${itemIdPrefix}${itemId}`);
        
        if (item) {
            document.getElementById('questionModalTitle').textContent = category === '問診' ? '編輯問題' : '編輯體檢項目';
            document.getElementById('questionCategory').value = category;
            document.getElementById('questionEditIndex').value = itemId;
            document.getElementById('questionText').value = item.value;
            
            const modal = new bootstrap.Modal(document.getElementById('addQuestionModal'));
            modal.show();
        }
    }
    
    // 刪除問題
    function handleDeleteItem(e) {
        if (confirm('確定要刪除此項目嗎？')) {
            const listItem = e.currentTarget.closest('.list-group-item');
            listItem.remove();
            updateSelectedItems();
        }
    }
    
    // 為現有的編輯和刪除按鈕添加事件監聽器
    document.querySelectorAll('.edit-question-btn, .edit-exam-btn').forEach(btn => {
        btn.addEventListener('click', handleEditItem);
    });
    
    document.querySelectorAll('.delete-question-btn, .delete-exam-btn').forEach(btn => {
        btn.addEventListener('click', handleDeleteItem);
    });
    
    // 更新已選擇的項目
    function updateSelectedItems() {
        const selectedQuestionsContainer = document.getElementById('selectedQuestions');
        const selectedExamsContainer = document.getElementById('selectedExams');
        
        // 清空容器
        selectedQuestionsContainer.innerHTML = '';
        selectedExamsContainer.innerHTML = '';
        
        // 獲取所有勾選的問題
        document.querySelectorAll('.question-checkbox:checked').forEach(checkbox => {
            const item = document.createElement('li');
            item.className = 'list-group-item';
            item.textContent = checkbox.value;
            selectedQuestionsContainer.appendChild(item);
        });
        
        // 獲取所有勾選的體檢項目
        document.querySelectorAll('.exam-checkbox:checked').forEach(checkbox => {
            const item = document.createElement('li');
            item.className = 'list-group-item';
            item.textContent = checkbox.value;
            selectedExamsContainer.appendChild(item);
        });
        
        // 如果沒有選中的項目，顯示提示
        if (selectedQuestionsContainer.children.length === 0) {
            const item = document.createElement('li');
            item.className = 'list-group-item text-muted';
            item.textContent = '尚未選擇問診項目';
            selectedQuestionsContainer.appendChild(item);
        }
        
        if (selectedExamsContainer.children.length === 0) {
            const item = document.createElement('li');
            item.className = 'list-group-item text-muted';
            item.textContent = '尚未選擇體檢項目';
            selectedExamsContainer.appendChild(item);
        }
    }
    
    // 儲存問診計劃
    document.getElementById('saveSelectedBtn').addEventListener('click', function() {
        const selectedQuestions = Array.from(document.querySelectorAll('.question-checkbox:checked')).map(c => c.value);
        const selectedExams = Array.from(document.querySelectorAll('.exam-checkbox:checked')).map(c => c.value);
        
        const data = {
            case_id: {{ case.id }},
            questions: selectedQuestions,
            exams: selectedExams
        };
        
        // 發送到後端儲存
        fetch('/medical/save-questionnaire', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('問診計劃已儲存！');
            } else {
                alert('儲存失敗：' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('儲存時發生錯誤，請稍後再試。');
        });
    });
    
    // 匯出問診計劃
    document.getElementById('exportSelectedBtn').addEventListener('click', function() {
        const selectedQuestions = Array.from(document.querySelectorAll('.question-checkbox:checked')).map(c => c.value);
        const selectedExams = Array.from(document.querySelectorAll('.exam-checkbox:checked')).map(c => c.value);
        
        let exportText = `醫療案例問診計劃\n`;
        exportText += `===================\n\n`;
        exportText += `病例ID: ${{{ case.id }}}\n`;
        exportText += `患者: ${{{ case.patient_age }}}歲 ${{{ case.patient_gender }}}\n`;
        exportText += `主訴: ${{{ case.chief_complaint }}}\n`;
        exportText += `專科: ${{{ case.specialty.name if case.specialty else "未指定" }}}\n\n`;
        
        exportText += `問診項目:\n`;
        selectedQuestions.forEach((q, i) => {
            exportText += `${i+1}. ${q}\n`;
        });
        
        exportText += `\n體檢項目:\n`;
        selectedExams.forEach((e, i) => {
            exportText += `${i+1}. ${e}\n`;
        });
        
        exportText += `\n創建時間: ${new Date().toLocaleString()}\n`;
        
        // 創建一個隱藏的元素來觸發下載
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(exportText));
        element.setAttribute('download', `問診計劃_病例${{{ case.id }}}_${new Date().toISOString().slice(0,10)}.txt`);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    });
    
    // 語音提示模式
    let currentQuestionIndex = -1;
    let questionList = [];
    let autoAdvanceTimer = null;
    
    document.getElementById('generateAudioBtn').addEventListener('click', function() {
        // 收集所有勾選的問題和體檢項目
        questionList = [];
        
        // 先添加所有勾選的問診項目
        document.querySelectorAll('.question-checkbox:checked').forEach(checkbox => {
            questionList.push(checkbox.value);
        });
        
        // 再添加所有勾選的體檢項目
        document.querySelectorAll('.exam-checkbox:checked').forEach(checkbox => {
            questionList.push(checkbox.value);
        });
        
        if (questionList.length === 0) {
            alert('請至少選擇一個問診或體檢項目');
            return;
        }
        
        // 重置進度
        currentQuestionIndex = -1;
        document.getElementById('questionProgress').style.width = '0%';
        document.getElementById('questionProgress').textContent = '0%';
        document.getElementById('currentQuestion').textContent = '按下「開始問診」按鈕開始';
        
        // 顯示即將進行的問題
        updateUpcomingQuestions();
        
        // 顯示模態框
        const modal = new bootstrap.Modal(document.getElementById('audioModeModal'));
        modal.show();
    });
    
    // 開始問診
    document.getElementById('startQuestioning').addEventListener('click', function() {
        if (questionList.length === 0) return;
        
        this.disabled = true;
        document.getElementById('stopQuestioning').disabled = false;
        document.getElementById('previousQuestion').disabled = false;
        document.getElementById('nextQuestion').disabled = false;
        
        // 顯示第一個問題
        currentQuestionIndex = 0;
        showCurrentQuestion();
        
        // 如果啟用了自動前進，設置定時器
        if (document.getElementById('autoAdvanceCheck').checked) {
            startAutoAdvanceTimer();
        }
    });
    
    // 下一個問題
    document.getElementById('nextQuestion').addEventListener('click', function() {
        if (currentQuestionIndex < questionList.length - 1) {
            currentQuestionIndex++;
            showCurrentQuestion();
            
            // 重設自動前進計時器
            if (document.getElementById('autoAdvanceCheck').checked) {
                clearTimeout(autoAdvanceTimer);
                startAutoAdvanceTimer();
            }
        }
    });
    
    // 上一個問題
    document.getElementById('previousQuestion').addEventListener('click', function() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            showCurrentQuestion();
            
            // 重設自動前進計時器
            if (document.getElementById('autoAdvanceCheck').checked) {
                clearTimeout(autoAdvanceTimer);
                startAutoAdvanceTimer();
            }
        }
    });
    
    // 停止問診
    document.getElementById('stopQuestioning').addEventListener('click', function() {
        clearTimeout(autoAdvanceTimer);
        this.disabled = true;
        document.getElementById('startQuestioning').disabled = false;
        document.getElementById('previousQuestion').disabled = true;
        document.getElementById('nextQuestion').disabled = true;
    });
    
    // 完成問診
    document.getElementById('completeQuestioning').addEventListener('click', function() {
        bootstrap.Modal.getInstance(document.getElementById('audioModeModal')).hide();
    });
    
    // 顯示當前問題
    function showCurrentQuestion() {
        if (currentQuestionIndex >= 0 && currentQuestionIndex < questionList.length) {
            const question = questionList[currentQuestionIndex];
            document.getElementById('currentQuestion').textContent = question;
            
            // 更新進度條
            const progress = Math.round((currentQuestionIndex + 1) / questionList.length * 100);
            document.getElementById('questionProgress').style.width = `${progress}%`;
            document.getElementById('questionProgress').textContent = `${progress}%`;
            
            // 語音朗讀問題
            if (document.getElementById('textToSpeechCheck').checked) {
                speakQuestion(question);
            }
            
            // 更新即將進行的問題列表
            updateUpcomingQuestions();
        }
    }
    
    // 語音朗讀
    function speakQuestion(text) {
        if ('speechSynthesis' in window) {
            // 取消任何正在進行的朗讀
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            // 嘗試找到中文語音
            const voices = window.speechSynthesis.getVoices();
            const chineseVoice = voices.find(voice => voice.lang.includes('zh'));
            if (chineseVoice) {
                utterance.voice = chineseVoice;
            }
            
            window.speechSynthesis.speak(utterance);
        }
    }
    
    // 更新即將進行的問題
    function updateUpcomingQuestions() {
        const container = document.getElementById('upcomingQuestions');
        container.innerHTML = '';
        
        // 從當前問題後開始顯示最多5個問題
        const startIdx = currentQuestionIndex + 1;
        const endIdx = Math.min(startIdx + 4, questionList.length);
        
        if (startIdx >= questionList.length) {
            const li = document.createElement('li');
            li.className = 'text-muted';
            li.textContent = '問診已完成';
            container.appendChild(li);
            return;
        }
        
        for (let i = startIdx; i < endIdx; i++) {
            const li = document.createElement('li');
            li.textContent = questionList[i];
            container.appendChild(li);
        }
        
        if (endIdx < questionList.length) {
            const li = document.createElement('li');
            li.className = 'text-muted';
            li.textContent = `...還有 ${questionList.length - endIdx} 個問題`;
            container.appendChild(li);
        }
    }
    
    // 自動前進計時器
    function startAutoAdvanceTimer() {
        clearTimeout(autoAdvanceTimer);
        autoAdvanceTimer = setTimeout(() => {
            if (currentQuestionIndex < questionList.length - 1) {
                currentQuestionIndex++;
                showCurrentQuestion();
                startAutoAdvanceTimer();
            } else {
                // 問診完成
                document.getElementById('stopQuestioning').click();
            }
        }, 10000); // 10秒自動前進
    }
    
    // 監聽自動前進選項變更
    document.getElementById('autoAdvanceCheck').addEventListener('change', function() {
        if (this.checked && document.getElementById('startQuestioning').disabled) {
            startAutoAdvanceTimer();
        } else {
            clearTimeout(autoAdvanceTimer);
        }
    });
    
    // 初始化已選擇的項目
    updateSelectedItems();
    
    // 確保語音合成API已加載
    if ('speechSynthesis' in window) {
        window.speechSynthesis.getVoices();
    }
});
</script>
{% endblock %}